#!/bin/bash

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Add dbadm user.
#======================================================================================================================

bf-adduser dbadm


#======================================================================================================================
# Get MariaDB version.
#======================================================================================================================

cd /tmp

VERSION=$(cat MARIADB_REVISION)
bf-echo "MariaDB version ${VERSION}."


#======================================================================================================================
# Install MariaDB and dependencies.
#======================================================================================================================

bf-echo "Installing MariaDB v${VERSION}..."
bf-ch -m 0644 /etc/apt/trusted.gpg.d/mariadb_release_signing_key.asc
DEBIAN_FRONTEND=noninteractive apt update && apt install -y --no-install-recommends \
    mariadb-server=1:${VERSION}* \
    mariadb-client=1:${VERSION}* \
    openssl
bf-done

bf-ch -o dbadm:dbadm -m 0644 /var/log/mariadb/error.log


#======================================================================================================================
# Cleanup.
#======================================================================================================================

bf-echo "Cleaning up default database config and files."
rm -rf /etc/my.cnf* /etc/mysql /var/lib/mysql/*


#======================================================================================================================
# Create MariaDB directories.
#======================================================================================================================

bf-echo "Creating MariaDB directories."

mkdir -p /var/lib/backup

mkdir -p /etc/my.cnf.d/ssl
mkdir /ssl


#======================================================================================================================
# Store default crontab as a template.
#======================================================================================================================

cp /etc/crontabs/root /etc/bf/templates/crontab.esh
