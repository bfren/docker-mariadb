#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Add dbadm user.
#======================================================================================================================

bf-adduser dbadm


#======================================================================================================================
# Get MariaDB version.
#======================================================================================================================

cd /tmp

VERSION=$(cat MARIADB_REVISION)
bf-echo "MariaDB version ${VERSION}."


#======================================================================================================================
# Install MariaDB and dependencies.
#======================================================================================================================

bf-echo "Installing MariaDB v${VERSION}..."
DEBIAN_FRONTEND=noninteractive apt update
DEBIAN_FRONTEND=noninteractive apt install add --no-install-recommends \
    openssl \
    mariadb-server=1:${VERSION}* \
    mariadb-client=1:${VERSION}*
bf-done

bf-ch -o dbadm:dbadm -m 0644 /var/log/mariadb/error.log


#======================================================================================================================
# Cleanup.
#======================================================================================================================

bf-echo "Cleaning up default database config and files."
rm -rf /etc/my.cnf* /etc/mysql /var/lib/mysql/*


#======================================================================================================================
# Create MariaDB directories.
#======================================================================================================================

bf-echo "Creating MariaDB directories."

mkdir -p /var/lib/backup

mkdir -p /etc/my.cnf.d/ssl
mkdir /ssl


#======================================================================================================================
# Add backup executable to main cron.
#======================================================================================================================

bf-echo "Adding db-backup to cron."
echo "0 */8 * * * db-backup" >> /etc/crontabs/root
