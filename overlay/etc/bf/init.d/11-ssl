#!/command/with-contenv bash

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# If SSL is not enabled, exit script gracefully.
#======================================================================================================================

[[ "${BF_DB_SSL_ENABLE}" != "1" ]] && bf-echo "SSL is not enabled." && exit 0


#======================================================================================================================
# If server certificate exists, exit script.
#======================================================================================================================

if [ -f ${BF_DB_SSL_CLIENT_CERT} ] ; then
    bf-ok "Using existing SSL certificates."
    exit 0
fi


#======================================================================================================================
# Call db-generate-certs executable.
#======================================================================================================================

db-generate-certs


#======================================================================================================================
# Copy client certificates to /ssl and make publicly readable.
#======================================================================================================================

cp -f ${BF_DB_SSL_CA_CERT} ${BF_DB_SSL}
cp -f ${BF_DB_SSL_CLIENT_KEY} ${BF_DB_SSL}
cp -f ${BF_DB_SSL_CLIENT_CERT} ${BF_DB_SSL}
bf-ch-apply ${BF_CH_D}/11-ssl
