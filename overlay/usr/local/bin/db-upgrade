#!/usr/bin/with-contenv bash

set -euo pipefail


#======================================================================================================================
# Check if upgrade is necessary
#======================================================================================================================

UPGRADE=${MARIADB_DATA}/mysql_upgrade_info
if [ -f ${UPGRADE} ] ; then

    UPGRADE_VERSION=$(tr -d '\0' < ${UPGRADE})
    bcg-debug "db-upgrade: Upgrade version ${UPGRADE_VERSION}"

    THIS_VERSION=$(mariadb --version)
    bcg-debug "db-upgrade: Current version ${THIS_VERSION}"

    [[ ${THIS_VERSION} == *"${UPGRADE_VERSION}"* ]] && bcg-echo "Upgrade is not necessary." && exit 0

fi


#======================================================================================================================
# Take backup first.
#======================================================================================================================

bcg-debug "db-upgrade: Taking backup before running mariadb-upgrade"
db-backup


#======================================================================================================================
# Run mariadb-upgrade as root user.
#======================================================================================================================

bcg-echo "Running mariadb-upgrade..."
mariadb-upgrade -uroot -p${MARIADB_ROOT_PASSWORD}
bcg-done
